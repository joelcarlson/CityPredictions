---
title: "Exploring Predictions"
author: "Joel Carlson"
date: "June 28, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "../")
```

In this markdown I explore the predicted trendlines for individual zipcodes.

Although trendlines are not the prediction target of this project (change in month over month median rent is), trendlines are perhaps a more intuitive visualization a lay audience. 

```{r, message=FALSE, warning=FALSE}
source("scripts/transform_model_predict_pipeline.R")
library(reshape2); library(ggplot2); library(dplyr); library(lazyeval)
load('data/NY_Info/brooklyn_zips.RData')
```

```{r, message=FALSE, warning=FALSE}
end_date <- c(2014,1)
test <- prediction_pipeline(zipcodes=brooklyn, train_end_date=end_date)
testing <- test[['testing']]
testing <- select(testing, zipcode, date,year, month, MRP_1Br, MRP_1Br_trend,MRP_1Br_MoM, MRP_1Br_raw_MoM, rf_preds, full_rf_preds,naive_preds)
#testing <- filter(testing, !is.na(MRP_1B_raw_MoM))
testing <- filter(testing, !is.na(MRP_1Br_MoM))
```

```{r,warning=FALSE}
ggplot(data=filter(testing, zipcode == 11218), aes(x=as.Date(date))) +
  geom_line(aes(y=MRP_1Br_MoM)) + 
  geom_line(aes(y=MRP_1Br_raw_MoM), alpha=0.5) + 
  geom_line(aes(y=naive_preds), color="red", lty=2) + 
  geom_line(aes(y=full_rf_preds), col="blue") +
  geom_line(aes(y=rf_preds), col="green") +
  coord_cartesian(ylim=c(0.97, 1.03))
```

Something interesting to look at would be those areas where the difference between Predictive ability of liquor and taxis vs not using liquor and taxis is large

Let's propogate the predictions through to reconstruct trends:

```{r}
prop_MoM <- function (value, MoM_vals) 
{
  MoM_vals <- MoM_vals[-1]
  k <- length(MoM_vals)
  values <- c(value)
  if (k > 1) {
    for (i in 1:k ) {
      value <- MoM_vals[[i]]*value
      values <- c(values, value)
    }
  }
  return(values)
}

#z10035 <- filter(z10035, !is.na(MRP_1Br_trend))
#prop_MoM(z10035$MRP_1Br_trend[1], z10035$MRP_1Br_MoM)
dat <- testing
trend_predictions <- dat %>% 
  filter(date >= as.Date(paste0(end_date[1], "-", end_date[2], "-15"))) %>% 
  group_by(zipcode) %>% 
  do({
    m <- filter(., !is.na(full_rf_preds)) %>% 
      select(date, zipcode, MRP_1Br, MRP_1Br_trend, full_rf_preds, rf_preds, naive_preds)
    try(
      m$MRP_1Br_trend_rf_pred <- prop_MoM(m$MRP_1Br_trend[1], m$rf_preds),
      silent=TRUE)
    try(
    m$MRP_1Br_trend_full_rf_pred <- prop_MoM(m$MRP_1Br_trend[1], m$full_rf_preds),
      silent=TRUE)
    try(
    m$MRP_1Br_trend_naive_pred <- prop_MoM(m$MRP_1Br_trend[1], m$naive_preds),
      silent=TRUE)
    m
  })
```



```{r, warning=FALSE}
trend_predictions <- select(trend_predictions, -full_rf_preds,
                            -rf_preds, -naive_preds,
                            -MRP_1Br, -MRP_1Br_trend)

tz <- left_join(dat, trend_predictions, by=c("zipcode", "date"))

tz <- select(tz, date, zipcode, MRP_1Br, MRP_1Br_trend,
             MRP_1Br_trend_rf_pred,
             MRP_1Br_trend_full_rf_pred,
             MRP_1Br_trend_naive_pred) %>% 
  filter(!is.na(MRP_1Br_trend))

q <- tz  %>% 
  group_by(zipcode) %>% 
  summarize("full"=mean(abs(MRP_1Br_trend - MRP_1Br_trend_full_rf_pred),na.rm=TRUE),
            "rf"= mean(abs(MRP_1Br_trend - MRP_1Br_trend_rf_pred),na.rm=TRUE),
            "naive"=mean(abs(MRP_1Br_trend - MRP_1Br_trend_naive_pred),na.rm=TRUE))

print(paste("Full Model:",mean(q$full, na.rm=TRUE)))
print(paste("Historical Model:",mean(q$rf, na.rm=TRUE)))
print(paste("Naive Model:",mean(q$naive, na.rm=TRUE)))


tz <- melt(tz, id.vars=c("zipcode","date")) 
# 11212 good choice
# 11223 good choice
# 11232 interesting
# 11238 cool too!
ggplot(data=filter(tz, zipcode == 11212),
       aes(x=date, y=value, col=variable, group=variable)) +
  geom_line() +
  guides(col=FALSE)
```












