---
title: "Analyze RMSE and SD of Predictions"
author: "Joel Carlson"
date: "June 29, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "../")
```
```{r, message=FALSE, warning=FALSE}
library(reshape2); library(dplyr); library(ggplot2); library(lazyeval)
```

In this document I explore the predictive accuracy of the models as they predict further into the future.

We will first examine the predictions of the Month over Month data, as this is the actual prediction target. However, the month over month data is not particularly intuitive, so we will then move on to looking at the accuracy in predicting actual median rental price trends. 

After examining the trends in median rental price in aggregate, we will investigate the trend accuracy in tighter granularity. I am particularly interested in any of the zipcodes for which the predictive accuracy using the taxi and liquor features was better than without. I will qualitativaly eamine the top few (if they exist), and report back the hopefully exciting results!


# Load and Create Data

The below functions extract the month over month RMSE, the aggregate trend RMSE for all NY zips, and then the trend RMSE by zip.

```{r, message=FALSE, cache=TRUE}
source("scripts/extract_RMSE_SD_from_predictions.R")
source("scripts/extract_RMSE_SD_from_trend_predictions.R")
base_path <- "data/temp/"
testing_paths_1Br <- list.files(base_path, pattern="MRP_1Br_testing")


MRP_1Br_RMSE <- extract_testing_RMSE_SD("MRP_1Br_MoM", testing_paths_1Br)
MRP_1Br_trend_RMSE <- extract_testing_trend_RMSE_SD_MRP_1Br(file_paths)
MRP_1Br_trend_RMSE_by_zip <- extract_testing_trend_RMSE_SD_MRP_1Br(file_paths, by_zip=TRUE)

MRP_1Br_RMSE$date <- as.Date(MRP_1Br_RMSE$date)
MRP_1Br_trend_RMSE$date <- as.Date(MRP_1Br_trend_RMSE$date)
MRP_1Br_trend_RMSE_by_zip$date <- as.Date(MRP_1Br_trend_RMSE_by_zip$date)
```

# MRP 1Br Month over Month 

````{r}
MRP_1Br_RMSE$months_in_future <- cut(as.numeric(MRP_1Br_RMSE$days_in_future),
                                     breaks=seq(from=1, to=365, length.out=13),
                                     labels=c(1:12))

MRP_1Br_RMSE_plt_dat <- MRP_1Br_RMSE %>% select(date, days_in_future, months_in_future, naive_RMSE, rf_RMSE, full_rf_RMSE) %>% melt(id.vars=c("date", "days_in_future", "months_in_future"))

ggplot(data=filter(MRP_1Br_RMSE_plt_dat, days_in_future <= 365),
       aes(x=months_in_future, y=value, group=months_in_future, fill=variable)) +
  geom_boxplot() +
  guides(fill=FALSE) +
  facet_wrap(~variable)
  #scale_color_viridis(discrete = TRUE)
```

# MRP 1Br Trend Prediction

```{r, warning=FALSE}

MRP_1Br_trend_RMSE$months_in_future <- cut(as.numeric(MRP_1Br_trend_RMSE$days_in_future),
                                            breaks=seq(from=1, to=365, length.out=13),
                                            labels=c(1:12))

MRP_1Br_trend_RMSE_plt_dat <- MRP_1Br_trend_RMSE %>% select(date, days_in_future, months_in_future, naive_trend_RMSE, rf_trend_RMSE, full_rf_trend_RMSE) %>% melt(id.vars=c("date", "days_in_future", "months_in_future"))

ggplot(data=filter(MRP_1Br_trend_RMSE_plt_dat, days_in_future <= 365),
       aes(x=months_in_future, y=value, group=months_in_future, fill=variable)) +
  geom_boxplot() +
  guides(fill=FALSE) +
  facet_wrap(~variable)
```

# MRP 1Br Trend Prediction by Zipcode

```{r, warning=FALSE}
MRP_1Br_trend_RMSE_by_zip$months_in_future <- cut(as.numeric(MRP_1Br_trend_RMSE_by_zip$days_in_future),
                                            breaks=seq(from=1, to=365, length.out=13),
                                            labels=c(1:12))
# Create a column of the difference between full and rf models
RMSE_diff_by_zip <- MRP_1Br_trend_RMSE_by_zip %>% 
  mutate(rf_diff = rf_trend_RMSE - full_rf_trend_RMSE) %>% 
  group_by(zipcode) %>% 
  summarize(mean_rf_diff = mean(rf_diff, na.rm=TRUE)) %>% 
  arrange(desc(mean_rf_diff))

knitr::kable(RMSE_diff_by_zip[1:10,])
```

Interestingly, the top two (11237, 11238) that are better predicted by the full models are surrounding neighborhoods of bedford-stuyvesant, a neighborhood which is rapidly gentrifying. Bed-stuy itself is number 9 on the list (and still better predicted by the full model) [link](http://www.nytimes.com/2015/11/29/nyregion/gentrification-in-a-brooklyn-neighborhood-forces-residents-to-move-on.html), [link](http://nypost.com/2016/01/07/gritty-bed-stuy-is-starting-to-show-its-softer-side/)

The vast majority of the top zips where full models outperform those lacking taxi and liquor data are locations listed on the NYU Furman center list of gentrifying areas [link](http://ny.curbed.com/2016/5/9/11641588/nyc-top-15-gentrifying-neighborhoods-williamsburg-harlem-bushwick)

```{r, warning=FALSE}

MRP_1Br_trend_RMSE_by_zip_plt_dat <- MRP_1Br_trend_RMSE_by_zip %>% 
  filter(zipcode %in% RMSE_diff_by_zip$zipcode[1:5]) %>% 
  select(date, days_in_future, months_in_future,
         rf_trend_RMSE,
         full_rf_trend_RMSE) %>%
  melt(id.vars=c("date", "days_in_future", "months_in_future"))

ggplot(data=filter(MRP_1Br_trend_RMSE_by_zip_plt_dat, days_in_future <= 365),
       aes(x=months_in_future, y=value, group=months_in_future, fill=variable)) +
  geom_boxplot() +
  guides(fill=FALSE) +
  facet_wrap(~variable)
```

```{r}

MRP_1Br_trend_RMSE_by_zip_plt_dat <- MRP_1Br_trend_RMSE_by_zip %>% 
  filter(zipcode %in% RMSE_diff_by_zip$zipcode[89:94]) %>% 
  select(date, days_in_future, months_in_future,
         rf_trend_RMSE,
         full_rf_trend_RMSE) %>%
  melt(id.vars=c("date", "days_in_future", "months_in_future"))

ggplot(data=filter(MRP_1Br_trend_RMSE_by_zip_plt_dat, days_in_future <= 365),
       aes(x=months_in_future, y=value, group=months_in_future, fill=variable)) +
  geom_boxplot() +
  guides(fill=FALSE) +
  facet_wrap(~variable)
```